name: CI

on:
  push:
    branches:
      - main
      - dev
    tags:
      - v*
  pull_request:
    branches:
      - main
      - dev

env:
  PYTHON_VERSION: "3.10"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: python -m pip install --upgrade pip
      - run: pip install .[dev]
      - run: make lint

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: python -m pip install --upgrade pip
      - run: pip install .[dev]
      - run: python -m pip install coverage-badge
      - name: Run tests with coverage
        run: make cov
        env:
          PYTEST_ADDOPTS: ""
          PYTHON: python
      - name: Generate coverage badge
        run: coverage-badge -f -o coverage.svg
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            .coverage
            coverage.xml
            pytest-junit.xml
            coverage.svg
      - name: Publish coverage status
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const xml = fs.readFileSync('coverage.xml', 'utf8');
            const match = xml.match(/line-rate="([\d.]+)"/);
            if (!match) {
              core.setFailed('coverage.xml missing line-rate attribute');
            } else {
              const pct = (Number(match[1]) * 100).toFixed(2);
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'success',
                target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: `coverage ${pct}%`,
                context: 'coverage',
              });
              core.info(`coverage status published: ${pct}%`);
            }

  build:
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: python -m pip install --upgrade pip
      - run: pip install .[dev]
      - run: make build
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  publish-testpypi:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev' && startsWith(github.event.head_commit.message, 'release-dev:')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: python -m pip install --upgrade pip maturin
      - env:
          TEST_PYPI_API_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: python -m maturin upload -r testpypi --username __token__ --password "$TEST_PYPI_API_TOKEN" dist/*

  publish-pypi:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
      - run: python -m pip install --upgrade pip maturin
      - env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m maturin upload --username __token__ --password "$PYPI_API_TOKEN" dist/*
